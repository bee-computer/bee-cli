import { createHash } from "crypto";

const EMOJI_LIST = [
  "ðŸ˜‰",
  "ðŸ˜",
  "ðŸ˜›",
  "ðŸ˜­",
  "ðŸ˜±",
  "ðŸ˜¡",
  "ðŸ˜Ž",
  "ðŸ˜´",
  "ðŸ˜µ",
  "ðŸ˜ˆ",
  "ðŸ˜¬",
  "ðŸ˜‡",
  "ðŸ˜",
  "ðŸ‘®",
  "ðŸ‘·",
  "ðŸ’‚",
  "ðŸ‘¶",
  "ðŸ‘¨",
  "ðŸ‘©",
  "ðŸ‘´",
  "ðŸ‘µ",
  "ðŸ˜»",
  "ðŸ˜½",
  "ðŸ™€",
  "ðŸ‘º",
  "ðŸ™ˆ",
  "ðŸ™‰",
  "ðŸ™Š",
  "ðŸ’€",
  "ðŸ‘½",
  "ðŸ’©",
  "ðŸ”¥",
  "ðŸ’¥",
  "ðŸ’¤",
  "ðŸ‘‚",
  "ðŸ‘€",
  "ðŸ‘ƒ",
  "ðŸ‘…",
  "ðŸ‘„",
  "ðŸ‘",
  "ðŸ‘Ž",
  "ðŸ‘Œ",
  "ðŸ‘Š",
  "âœŒï¸",
  "âœ‹ï¸",
  "ðŸ‘",
  "ðŸ‘†",
  "ðŸ‘‡",
  "ðŸ‘‰",
  "ðŸ‘ˆ",
  "ðŸ™",
  "ðŸ‘",
  "ðŸ’ª",
  "ðŸš¶",
  "ðŸƒ",
  "ðŸ’ƒ",
  "ðŸ‘«",
  "ðŸ‘ª",
  "ðŸ‘¬",
  "ðŸ‘­",
  "ðŸ’…",
  "ðŸŽ©",
  "ðŸ‘‘",
  "ðŸ‘’",
  "ðŸ‘Ÿ",
  "ðŸ‘ž",
  "ðŸ‘ ",
  "ðŸ‘•",
  "ðŸ‘—",
  "ðŸ‘–",
  "ðŸ‘™",
  "ðŸ‘œ",
  "ðŸ‘“",
  "ðŸŽ€",
  "ðŸ’„",
  "ðŸ’›",
  "ðŸ’™",
  "ðŸ’œ",
  "ðŸ’š",
  "ðŸ’",
  "ðŸ’Ž",
  "ðŸ¶",
  "ðŸº",
  "ðŸ±",
  "ðŸ­",
  "ðŸ¹",
  "ðŸ°",
  "ðŸ¸",
  "ðŸ¯",
  "ðŸ¨",
  "ðŸ»",
  "ðŸ·",
  "ðŸ®",
  "ðŸ—",
  "ðŸ´",
  "ðŸ‘",
  "ðŸ˜",
  "ðŸ¼",
  "ðŸ§",
  "ðŸ¥",
  "ðŸ”",
  "ðŸ",
  "ðŸ¢",
  "ðŸ›",
  "ðŸ",
  "ðŸœ",
  "ðŸž",
  "ðŸŒ",
  "ðŸ™",
  "ðŸš",
  "ðŸŸ",
  "ðŸ¬",
  "ðŸ‹",
  "ðŸ",
  "ðŸŠ",
  "ðŸ«",
  "ðŸ€",
  "ðŸŒ¹",
  "ðŸŒ»",
  "ðŸ",
  "ðŸŒ¾",
  "ðŸ„",
  "ðŸŒµ",
  "ðŸŒ´",
  "ðŸŒ³",
  "ðŸŒž",
  "ðŸŒš",
  "ðŸŒ™",
  "ðŸŒŽ",
  "ðŸŒ‹",
  "âš¡ï¸",
  "â˜”ï¸",
  "â„ï¸",
  "â›„ï¸",
  "ðŸŒ€",
  "ðŸŒˆ",
  "ðŸŒŠ",
  "ðŸŽ“",
  "ðŸŽ†",
  "ðŸŽƒ",
  "ðŸ‘»",
  "ðŸŽ…",
  "ðŸŽ„",
  "ðŸŽ",
  "ðŸŽˆ",
  "ðŸ”®",
  "ðŸŽ¥",
  "ðŸ“·",
  "ðŸ’¿",
  "ðŸ’»",
  "â˜Žï¸",
  "ðŸ“¡",
  "ðŸ“º",
  "ðŸ“»",
  "ðŸ”‰",
  "ðŸ””",
  "â³",
  "â°",
  "âŒšï¸",
  "ðŸ”’",
  "ðŸ”‘",
  "ðŸ”Ž",
  "ðŸ’¡",
  "ðŸ”¦",
  "ðŸ”Œ",
  "ðŸ”‹",
  "ðŸš¿",
  "ðŸš½",
  "ðŸ”§",
  "ðŸ”¨",
  "ðŸšª",
  "ðŸš¬",
  "ðŸ’£",
  "ðŸ”«",
  "ðŸ”ª",
  "ðŸ’Š",
  "ðŸ’‰",
  "ðŸ’°",
  "ðŸ’µ",
  "ðŸ’³",
  "âœ‰ï¸",
  "ðŸ“«",
  "ðŸ“¦",
  "ðŸ“…",
  "ðŸ“",
  "âœ‚ï¸",
  "ðŸ“Œ",
  "ðŸ“Ž",
  "âœ’ï¸",
  "âœï¸",
  "ðŸ“",
  "ðŸ“š",
  "ðŸ”¬",
  "ðŸ”­",
  "ðŸŽ¨",
  "ðŸŽ¬",
  "ðŸŽ¤",
  "ðŸŽ§",
  "ðŸŽµ",
  "ðŸŽ¹",
  "ðŸŽ»",
  "ðŸŽº",
  "ðŸŽ¸",
  "ðŸ‘¾",
  "ðŸŽ®",
  "ðŸƒ",
  "ðŸŽ²",
  "ðŸŽ¯",
  "ðŸˆ",
  "ðŸ€",
  "âš½ï¸",
  "âš¾ï¸",
  "ðŸŽ¾",
  "ðŸŽ±",
  "ðŸ‰",
  "ðŸŽ³",
  "ðŸ",
  "ðŸ‡",
  "ðŸ†",
  "ðŸŠ",
  "ðŸ„",
  "â˜•ï¸",
  "ðŸ¼",
  "ðŸº",
  "ðŸ·",
  "ðŸ´",
  "ðŸ•",
  "ðŸ”",
  "ðŸŸ",
  "ðŸ—",
  "ðŸ±",
  "ðŸš",
  "ðŸœ",
  "ðŸ¡",
  "ðŸ³",
  "ðŸž",
  "ðŸ©",
  "ðŸ¦",
  "ðŸŽ‚",
  "ðŸ°",
  "ðŸª",
  "ðŸ«",
  "ðŸ­",
  "ðŸ¯",
  "ðŸŽ",
  "ðŸ",
  "ðŸŠ",
  "ðŸ‹",
  "ðŸ’",
  "ðŸ‡",
  "ðŸ‰",
  "ðŸ“",
  "ðŸ‘",
  "ðŸŒ",
  "ðŸ",
  "ðŸ",
  "ðŸ†",
  "ðŸ…",
  "ðŸŒ½",
  "ðŸ¡",
  "ðŸ¥",
  "ðŸ¦",
  "â›ªï¸",
  "ðŸ°",
  "â›ºï¸",
  "ðŸ­",
  "ðŸ—»",
  "ðŸ—½",
  "ðŸŽ ",
  "ðŸŽ¡",
  "â›²ï¸",
  "ðŸŽ¢",
  "ðŸš¢",
  "ðŸš¤",
  "âš“ï¸",
  "ðŸš€",
  "âœˆï¸",
  "ðŸš",
  "ðŸš‚",
  "ðŸš‹",
  "ðŸšŽ",
  "ðŸšŒ",
  "ðŸš™",
  "ðŸš—",
  "ðŸš•",
  "ðŸš›",
  "ðŸš¨",
  "ðŸš”",
  "ðŸš’",
  "ðŸš‘",
  "ðŸš²",
  "ðŸš ",
  "ðŸšœ",
  "ðŸš¦",
  "âš ï¸",
  "ðŸš§",
  "â›½ï¸",
  "ðŸŽ°",
  "ðŸ—¿",
  "ðŸŽª",
  "ðŸŽ­",
  "ðŸ‡¯ðŸ‡µ",
  "ðŸ‡°ðŸ‡·",
  "ðŸ‡©ðŸ‡ª",
  "ðŸ‡¨ðŸ‡³",
  "ðŸ‡ºðŸ‡¸",
  "ðŸ‡«ðŸ‡·",
  "ðŸ‡ªðŸ‡¸",
  "ðŸ‡®ðŸ‡¹",
  "ðŸ‡·ðŸ‡º",
  "ðŸ‡¬ðŸ‡§",
  "1ï¸âƒ£",
  "2ï¸âƒ£",
  "3ï¸âƒ£",
  "4ï¸âƒ£",
  "5ï¸âƒ£",
  "6ï¸âƒ£",
  "7ï¸âƒ£",
  "8ï¸âƒ£",
  "9ï¸âƒ£",
  "0ï¸âƒ£",
  "ðŸ”Ÿ",
  "â—ï¸",
  "â“",
  "â™¥ï¸",
  "â™¦ï¸",
  "ðŸ’¯",
  "ðŸ”—",
  "ðŸ”±",
  "ðŸ”´",
  "ðŸ”µ",
  "ðŸ”¶",
  "ðŸ”·",
] as const;

const HASH_BYTES = 32;
const BYTES_PER_EMOJI = 8;

function positionExtractor(bytes: Uint8Array, index: number, count: number): number {
  const offset = index * BYTES_PER_EMOJI;
  if (offset + 7 >= bytes.length) {
    return 0;
  }

  const b0 = bytes[offset] ?? 0;
  const b1 = bytes[offset + 1] ?? 0;
  const b2 = bytes[offset + 2] ?? 0;
  const b3 = bytes[offset + 3] ?? 0;
  const b4 = bytes[offset + 4] ?? 0;
  const b5 = bytes[offset + 5] ?? 0;
  const b6 = bytes[offset + 6] ?? 0;
  const b7 = bytes[offset + 7] ?? 0;

  const num =
    (BigInt(b0 & 0x7f) << 56n) |
    (BigInt(b1 & 0xff) << 48n) |
    (BigInt(b2 & 0xff) << 40n) |
    (BigInt(b3 & 0xff) << 32n) |
    (BigInt(b4 & 0xff) << 24n) |
    (BigInt(b5 & 0xff) << 16n) |
    (BigInt(b6 & 0xff) << 8n) |
    BigInt(b7 & 0xff);

  return Number(num % BigInt(count));
}

export function emojiHash(publicKeyBytes: Uint8Array, count = 4): string[] {
  if (!Number.isInteger(count) || count <= 0) {
    return [];
  }

  const hash = createHash("sha256").update(publicKeyBytes).digest();
  return emojiHashFromHash(hash, count);
}

function emojiHashFromHash(hashBytes: Uint8Array, count: number): string[] {
  if (hashBytes.length !== HASH_BYTES) {
    return [];
  }

  if (!Number.isInteger(count) || count <= 0) {
    return [];
  }

  if (count * BYTES_PER_EMOJI > hashBytes.length) {
    return [];
  }

  const result: string[] = [];
  const emojiCount = EMOJI_LIST.length;

  for (let i = 0; i < count; i += 1) {
    const position = positionExtractor(hashBytes, i, emojiCount);
    const emoji = EMOJI_LIST[position];
    if (emoji === undefined) {
      return [];
    }
    result.push(emoji);
  }

  return result;
}
